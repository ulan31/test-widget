<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç –≤–∏–¥–∂–µ—Ç–∞</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      color: white;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .editor-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      width: 100%;
      max-width: 800px;
    }

    .editor-header {
      background: #f9fafb;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-header span {
      font-weight: 600;
      color: #374151;
      font-size: 16px;
    }

    .btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    textarea {
      width: 100%;
      height: 300px;
      padding: 20px;
      border: none;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      color: #1f2937;
    }

    .hint {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-left: 4px solid white;
      padding: 16px 20px;
      margin-top: 30px;
      border-radius: 8px;
      font-size: 14px;
      max-width: 800px;
      width: 100%;
    }

    .hint strong {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
    }

    code {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ */
    #widgetContainer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }

    /* –ö–æ–Ω—Å–æ–ª—å –æ—Ç–ª–∞–¥–∫–∏ */
    .debug-console {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      width: 100%;
      max-width: 800px;
      margin-top: 20px;
    }

    .console-header {
      background: #1f2937;
      color: white;
      padding: 12px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .console-body {
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: #f9fafb;
    }

    .log-entry {
      padding: 8px 12px;
      margin-bottom: 4px;
      border-radius: 4px;
      border-left: 3px solid #3b82f6;
      background: white;
    }

    .log-entry.error {
      border-left-color: #ef4444;
      background: #fef2f2;
      color: #991b1b;
    }

    .log-entry.success {
      border-left-color: #10b981;
      background: #f0fdf4;
      color: #166534;
    }

    .log-entry.warning {
      border-left-color: #f59e0b;
      background: #fffbeb;
      color: #92400e;
    }

    .log-time {
      color: #6b7280;
      font-size: 11px;
      margin-right: 8px;
    }

    .btn-clear {
      background: #6b7280;
      font-size: 12px;
      padding: 6px 12px;
    }

    .btn-clear:hover {
      background: #4b5563;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    .status-loading {
      background: #f59e0b;
    }

    .status-success {
      background: #10b981;
    }

    .status-error {
      background: #ef4444;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* –õ–æ–∞–¥–µ—Ä –≤–∏–¥–∂–µ—Ç–∞ */
    .widget-loader {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 8888; /* –ù–∏–∂–µ —á–µ–º z-index –≤–∏–¥–∂–µ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –µ–≥–æ */
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      display: none;
      align-items: center;
      gap: 12px;
      animation: fadeIn 0.3s ease;
      pointer-events: none; /* –õ–æ–∞–¥–µ—Ä –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ */
    }

    .widget-loader.active {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loader-text {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
    }

    .loader-subtext {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    .progress-bar {
      width: 200px;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üß™ –¢–µ—Å—Ç –≤–∏–¥–∂–µ—Ç–∞ —á–∞—Ç–∞</h1>
    <p>–í—Å—Ç–∞–≤—å –∫–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞ –≤–∏–¥–∂–µ—Ç–∞ –∏ –Ω–∞–∂–º–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–∂–µ—Ç"</p>
  </div>

  <div class="editor-container">
    <div class="editor-header">
      <span>üìù –ö–æ–¥ –≤–∏–¥–∂–µ—Ç–∞</span>
      <div style="display: flex; gap: 8px;">
        <button class="btn" onclick="loadWidget(event); return false;">üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–∂–µ—Ç</button>
        <button class="btn" style="background: #6b7280;" onclick="inspectDOM(); return false;">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DOM</button>
      </div>
    </div>
    <textarea id="widgetCode" spellcheck="false" placeholder='–í—Å—Ç–∞–≤—å —Å—é–¥–∞ –∫–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä:
<script 
  src="https://assistant-test.discoverbeagle.com/api/assistant/embed/widget" 
  data-lawyer-id="fpm3a7d2gi" 
  data-button-color="#5C33CF"
  async
></script>'><script 
  src="https://assistant-test.discoverbeagle.com/api/assistant/embed/widget" 
  data-lawyer-id="fpm3a7d2gi" 
  data-button-color="#5C33CF"
  async
></script></textarea>
  </div>

  <div class="hint">
    <strong>üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong>
    –í—Å—Ç–∞–≤—å –∫–æ–¥ –≤–∏–¥–∂–µ—Ç–∞ –≤ –ø–æ–ª–µ –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏ <strong>"–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–∂–µ—Ç"</strong>. 
    –í–∏–¥–∂–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è —Å–ø—Ä–∞–≤–∞ –≤–Ω–∏–∑—É —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚¨áÔ∏è
  </div>

  <!-- –ö–æ–Ω—Å–æ–ª—å –æ—Ç–ª–∞–¥–∫–∏ -->
  <div class="debug-console">
    <div class="console-header">
      <span>üîç –ö–æ–Ω—Å–æ–ª—å –æ—Ç–ª–∞–¥–∫–∏</span>
      <button class="btn btn-clear" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <div class="console-body" id="consoleLog">
      <div class="log-entry">
        <span class="log-time">[00:00:00]</span>
        –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞. –ñ–¥—É –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞...
      </div>
    </div>
  </div>

  <!-- –õ–æ–∞–¥–µ—Ä –≤–∏–¥–∂–µ—Ç–∞ -->
  <div class="widget-loader" id="widgetLoader">
    <div class="spinner"></div>
    <div>
      <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–∂–µ—Ç–∞...</div>
      <div class="loader-subtext" id="loaderSubtext">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    // ========================================
    function getTimeStamp() {
      const now = new Date();
      return now.toTimeString().split(' ')[0];
    }

    function addLog(message, type = 'info') {
      const consoleBody = document.getElementById('consoleLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="log-time">[${getTimeStamp()}]</span>${message}`;
      consoleBody.appendChild(entry);
      consoleBody.scrollTop = consoleBody.scrollHeight;
    }

    function clearLogs() {
      const consoleBody = document.getElementById('consoleLog');
      consoleBody.innerHTML = '<div class="log-entry"><span class="log-time">[' + getTimeStamp() + ']</span>–ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞</div>';
    }

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.log/error/warn
    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;

    console.log = function(...args) {
      originalConsoleLog.apply(console, args);
      addLog(args.join(' '), 'info');
    };

    console.error = function(...args) {
      originalConsoleError.apply(console, args);
      addLog('‚ùå ' + args.join(' '), 'error');
    };

    console.warn = function(...args) {
      originalConsoleWarn.apply(console, args);
      addLog('‚ö†Ô∏è ' + args.join(' '), 'warning');
    };

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
    window.addEventListener('error', (event) => {
      addLog(`‚ùå JavaScript Error: ${event.message} (${event.filename}:${event.lineno})`, 'error');
    });

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ promise rejections
    window.addEventListener('unhandledrejection', (event) => {
      addLog(`‚ùå Promise Rejection: ${event.reason}`, 'error');
    });

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º fetch/XHR –∑–∞–ø—Ä–æ—Å—ã
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      const url = args[0];
      addLog(`üåê Fetch –∑–∞–ø—Ä–æ—Å: ${url}`, 'info');
      
      return originalFetch.apply(this, args)
        .then(response => {
          if (response.ok) {
            addLog(`‚úÖ Fetch —É—Å–ø–µ—à–µ–Ω: ${url} (${response.status})`, 'success');
          } else {
            addLog(`‚ùå Fetch –æ—à–∏–±–∫–∞: ${url} (${response.status})`, 'error');
          }
          return response;
        })
        .catch(error => {
          addLog(`‚ùå Fetch –ø—Ä–æ–≤–∞–ª–µ–Ω: ${url} - ${error.message}`, 'error');
          throw error;
        });
    };

    // ========================================
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∞–¥–µ—Ä–æ–º
    // ========================================
    function showLoader(text = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', progress = 0) {
      const loader = document.getElementById('widgetLoader');
      const subtext = document.getElementById('loaderSubtext');
      const progressFill = document.getElementById('progressFill');
      loader.classList.add('active');
      subtext.textContent = text;
      progressFill.style.width = progress + '%';
    }

    function hideLoader() {
      const loader = document.getElementById('widgetLoader');
      const progressFill = document.getElementById('progressFill');
      progressFill.style.width = '100%';
      
      setTimeout(() => {
        loader.classList.remove('active');
        progressFill.style.width = '0%';
      }, 500);
    }

    function updateLoaderText(text, progress = null) {
      const subtext = document.getElementById('loaderSubtext');
      const progressFill = document.getElementById('progressFill');
      subtext.textContent = text;
      if (progress !== null) {
        progressFill.style.width = progress + '%';
      }
    }

    // ========================================
    // –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä DOM
    // ========================================
    function inspectDOM() {
      addLog('üîç –ü—Ä–æ–≤–µ—Ä—è—é —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ DOM...', 'info');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ body
      const allElements = document.body.querySelectorAll('*');
      let widgetFound = false;
      
      addLog(`üìä –í—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ DOM: ${allElements.length}`, 'info');
      
      // –ò—â–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–∏–¥–∂–µ—Ç–∞
      const potentialWidgets = [];
      allElements.forEach(el => {
        const hasWidgetId = el.id && (el.id.includes('widget') || el.id.includes('chat') || el.id.includes('assistant'));
        const hasWidgetClass = el.className && typeof el.className === 'string' && 
          (el.className.includes('widget') || el.className.includes('chat') || el.className.includes('assistant'));
        const isIframe = el.tagName === 'IFRAME';
        
        if ((hasWidgetId || hasWidgetClass || isIframe) && 
            !el.id.includes('widgetLoader') && 
            !el.id.includes('widgetCode')) {
          potentialWidgets.push({
            tag: el.tagName,
            id: el.id || '–Ω–µ—Ç',
            class: el.className || '–Ω–µ—Ç',
            visible: el.offsetWidth > 0 && el.offsetHeight > 0,
            position: window.getComputedStyle(el).position,
            zIndex: window.getComputedStyle(el).zIndex,
            display: window.getComputedStyle(el).display
          });
        }
      });
      
      if (potentialWidgets.length > 0) {
        addLog(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${potentialWidgets.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞ –≤–∏–¥–∂–µ—Ç:`, 'success');
        potentialWidgets.forEach((w, i) => {
          addLog(`  ${i+1}. <${w.tag}> id="${w.id}" class="${w.class}" visible=${w.visible} position=${w.position} z-index=${w.zIndex} display=${w.display}`, 'info');
        });
      } else {
        addLog('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ DOM', 'error');
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã
      const scripts = document.querySelectorAll('script[data-lawyer-id]');
      if (scripts.length > 0) {
        addLog(`üìú –ù–∞–π–¥–µ–Ω–æ ${scripts.length} —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤–∏–¥–∂–µ—Ç–∞`, 'success');
        scripts.forEach((s, i) => {
          addLog(`  ${i+1}. src="${s.src}" lawyer-id="${s.getAttribute('data-lawyer-id')}"`, 'info');
        });
      } else {
        addLog('‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç—ã –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
      }
      
      return false;
    }

    // ========================================
    // –î–µ—Ç–µ–∫—Ç–æ—Ä –ø–æ—è–≤–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞
    // ========================================
    let widgetObserver = null;
    
    function startWidgetDetection() {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π observer –µ—Å–ª–∏ –µ—Å—Ç—å
      if (widgetObserver) {
        widgetObserver.disconnect();
      }

      addLog('üëÄ –ó–∞–ø—É—Å–∫–∞—é –¥–µ—Ç–µ–∫—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–∞ –≤ DOM...', 'info');

      // –°–æ–∑–¥–∞–µ–º MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      widgetObserver = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
          if (mutation.addedNodes.length > 0) {
            mutation.addedNodes.forEach((node) => {
              // –õ–æ–≥–∏—Ä—É–µ–º –í–°–ï –¥–æ–±–∞–≤–ª—è–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
              if (node.nodeType === 1) { // ELEMENT_NODE
                const tag = node.tagName;
                const id = node.id || '';
                const className = typeof node.className === 'string' ? node.className : '';
                
                // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
                addLog(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω —ç–ª–µ–º–µ–Ω—Ç: <${tag}> id="${id}" class="${className}"`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–∏–¥–∂–µ—Ç–æ–≤
                const isWidget = 
                  id.includes('widget') || 
                  id.includes('chat') ||
                  id.includes('assistant') ||
                  id.includes('beagle') ||
                  className.includes('widget') ||
                  className.includes('chat') ||
                  className.includes('assistant') ||
                  className.includes('beagle') ||
                  (tag === 'IFRAME' && node.src?.includes('assistant')) ||
                  (tag === 'IFRAME' && node.src?.includes('beagle')) ||
                  tag === 'DIV' && node.querySelector('iframe');
                
                if (isWidget) {
                  addLog(`‚úÖ –í–ò–î–ñ–ï–¢ –û–ë–ù–ê–†–£–ñ–ï–ù! <${tag}> id="${id}" class="${className}"`, 'success');
                  
                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
                  setTimeout(() => {
                    const isVisible = node.offsetWidth > 0 && node.offsetHeight > 0;
                    const style = window.getComputedStyle(node);
                    addLog(`  üìê –í–∏–¥–∏–º–æ—Å—Ç—å: ${isVisible}, display: ${style.display}, position: ${style.position}, z-index: ${style.zIndex}`, 'info');
                    
                    if (isVisible) {
                      hideLoader();
                      addLog('üéâ –í–∏–¥–∂–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –í–ò–î–ï–ù!', 'success');
                    } else {
                      addLog('‚ö†Ô∏è –í–∏–¥–∂–µ—Ç –≤ DOM, –Ω–æ –ù–ï –í–ò–î–ï–ù! –ü—Ä–æ–≤–µ—Ä—å CSS...', 'warning');
                      // –í—Å—ë —Ä–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
                      setTimeout(hideLoader, 2000);
                    }
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
                    if (widgetObserver) {
                      widgetObserver.disconnect();
                    }
                  }, 500);
                }
              }
            });
          }
        }
      });

      // –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ body
      widgetObserver.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['class', 'id', 'style']
      });
    }

    // ========================================
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
    // ========================================
    function loadWidget(event) {
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ª—é–±—ã–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }

      addLog('üîÑ –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É –≤–∏–¥–∂–µ—Ç–∞...', 'info');
      showLoader('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...', 10);
      
      const code = document.getElementById('widgetCode').value.trim();
      
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–∏–¥–∂–µ—Ç–∞
      document.querySelectorAll('[id*="widget"], [id*="chat"], [class*="widget"], [class*="chat"]').forEach(el => {
        if (!el.id.includes('widgetLoader') && !el.id.includes('widgetCode')) {
          addLog(`üóëÔ∏è –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∂–µ—Ç–∞: ${el.tagName}`, 'warning');
          el.remove();
        }
      });
      
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –≤–∏–¥–∂–µ—Ç–∞
      const oldScripts = document.querySelectorAll('script[data-lawyer-id]');
      if (oldScripts.length > 0) {
        addLog(`üóëÔ∏è –£–¥–∞–ª—è—é ${oldScripts.length} —Å—Ç–∞—Ä—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤`, 'warning');
        oldScripts.forEach(script => script.remove());
      }
      
      if (!code) {
        addLog('‚ö†Ô∏è –ö–æ–¥ –≤–∏–¥–∂–µ—Ç–∞ –ø—É—Å—Ç–æ–π!', 'error');
        hideLoader();
        alert('‚ö†Ô∏è –í—Å—Ç–∞–≤—å –∫–æ–¥ –≤–∏–¥–∂–µ—Ç–∞!');
        return false;
      }
      
      setTimeout(() => updateLoaderText('–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–¥–∞...', 25), 200);
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ –∫–æ–¥–∞
      const parser = new DOMParser();
      const doc = parser.parseFromString(code, 'text/html');
      const scriptTag = doc.querySelector('script');
      
      if (!scriptTag) {
        addLog('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ç–µ–≥ <script> –≤ –∫–æ–¥–µ', 'error');
        hideLoader();
        alert('‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –í—Å—Ç–∞–≤—å –∫–æ–¥ <script>');
        return false;
      }
      
      // –õ–æ–≥–∏—Ä—É–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã
      const src = scriptTag.getAttribute('src');
      const lawyerId = scriptTag.getAttribute('data-lawyer-id');
      const buttonColor = scriptTag.getAttribute('data-button-color');
      
      addLog(`üìã URL —Å–∫—Ä–∏–ø—Ç–∞: ${src}`, 'info');
      addLog(`üìã Lawyer ID: ${lawyerId}`, 'info');
      addLog(`üìã –¶–≤–µ—Ç –∫–Ω–æ–ø–∫–∏: ${buttonColor}`, 'info');
      
      setTimeout(() => updateLoaderText('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞...', 40), 400);
      
      // –í–ê–ñ–ù–û: –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–∞ –î–û –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
      startWidgetDetection();
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π script —ç–ª–µ–º–µ–Ω—Ç
      const newScript = document.createElement('script');
      
      // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã
      Array.from(scriptTag.attributes).forEach(attr => {
        newScript.setAttribute(attr.name, attr.value);
      });
      
      // –¢–∞–π–º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –µ—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –∑–∞ 10 —Å–µ–∫—É–Ω–¥
      let safetyTimer = setTimeout(() => {
        addLog('‚ö†Ô∏è –í–∏–¥–∂–µ—Ç –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –∑–∞ 10 —Å–µ–∫—É–Ω–¥. –í–æ–∑–º–æ–∂–Ω–æ –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.', 'warning');
        hideLoader();
        if (widgetObserver) {
          widgetObserver.disconnect();
        }
      }, 10000);
      
      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–∫—Ä–∏–ø—Ç–∞
      newScript.onload = function() {
        addLog('‚úÖ –°–∫—Ä–∏–ø—Ç –≤–∏–¥–∂–µ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
        addLog('‚è≥ –û–∂–∏–¥–∞—é –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ –≤ DOM...', 'info');
        updateLoaderText('–û–∂–∏–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞...', 70);
        
        setTimeout(() => {
          updateLoaderText('–ü–æ–∏—Å–∫ –≤–∏–¥–∂–µ—Ç–∞...', 85);
        }, 1500);
      };
      
      newScript.onerror = function(e) {
        addLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞: ${e}`, 'error');
        hideLoader();
        clearTimeout(safetyTimer);
        if (widgetObserver) {
          widgetObserver.disconnect();
        }
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –≤ body
      setTimeout(() => {
        document.body.appendChild(newScript);
        addLog('üì§ –°–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ DOM', 'info');
        updateLoaderText('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...', 55);
      }, 600);
      
      return false; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ª—é–±—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    }

    // ========================================
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // ========================================
    
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    let widgetLoaded = false;
    
    window.addEventListener('beforeunload', (event) => {
      if (widgetLoaded) {
        // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        // event.preventDefault();
        // event.returnValue = '';
        addLog('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞', 'warning');
      }
    });

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    document.addEventListener('submit', (event) => {
      event.preventDefault();
      addLog('‚ö†Ô∏è –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã', 'warning');
      return false;
    });

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Å—ã–ª–∫–∞–º
    document.addEventListener('click', (event) => {
      const target = event.target.closest('a');
      if (target && target.href && target.href !== '#' && !target.target) {
        const url = target.href;
        if (!url.startsWith('javascript:')) {
          addLog(`‚ö†Ô∏è –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ: ${url}`, 'warning');
          event.preventDefault();
          return false;
        }
      }
    });

    // ========================================
    // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // ========================================
    window.addEventListener('load', () => {
      addLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞—é –≤–∏–¥–∂–µ—Ç —á–µ—Ä–µ–∑ 500ms...', 'success');
      setTimeout(() => {
        loadWidget();
        widgetLoaded = true;
      }, 500);
    });

    addLog('‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ª–∞–¥–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'success');
  </script>
</body>
</html>